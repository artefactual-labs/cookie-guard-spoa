[cookie-guard]
spoe-agent cookie-guard
    option var-prefix cookieguard
    groups issue-token verify-token
    option pipelining
    timeout hello      2s
    timeout idle       30s
    timeout processing 2s
    use-backend cookie_guard_spoa_backend
    log global

spoe-message issue-token
    args src-ip=src ua="req.fhdr(User-Agent)"

spoe-message verify-token
    args src-ip=src ua="req.fhdr(User-Agent)" cookie=req.cook(hb_v2)

spoe-group issue-token
    messages issue-token

spoe-group verify-token
    messages verify-token

# Optional: route ALTCHA endpoints to the agent's HTTP listener (metrics port)
# Add matching rules in your frontend, e.g.:
#   acl altcha_path path_beg -i /altcha-
#   use_backend cookie_guard_http_backend if altcha_path
# This backend serves /altcha-challenge and /altcha-verify.
#
# Disabled by default â€” uncomment to enable.
# backend cookie_guard_http_backend
#     mode http
#     server spoa_http 127.0.0.1:9904 check

# Optional: serve versioned ALTCHA JS from disk (place .lf at /etc/haproxy/assets/altcha/active/altcha.min.js.lf)
# In your frontend:
#   acl altcha_js path -i /assets/altcha/active/altcha.min.js
#   http-request return lf-file /etc/haproxy/assets/altcha/active/altcha.min.js.lf if altcha_js
